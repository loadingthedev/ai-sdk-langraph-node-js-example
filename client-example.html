<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chat Client</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .chat-container {
        border: 1px solid #ccc;
        border-radius: 8px;
        height: 400px;
        overflow-y: auto;
        padding: 15px;
        margin-bottom: 15px;
      }
      .message {
        margin-bottom: 15px;
        padding: 10px;
        border-radius: 8px;
      }
      .user {
        background-color: #e1f5fe;
        align-self: flex-end;
      }
      .assistant {
        background-color: #f5f5f5;
      }
      .input-container {
        display: flex;
        gap: 10px;
      }
      #messageInput {
        flex-grow: 1;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #ccc;
      }
      button {
        padding: 10px 15px;
        background-color: #2196f3;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background-color: #0b7dda;
      }
    </style>
  </head>
  <body>
    <h1>AI Chat Client</h1>
    <div class="chat-container" id="chatContainer"></div>
    <div class="input-container">
      <input type="text" id="messageInput" placeholder="Type your message..." />
      <button id="sendButton">Send</button>
    </div>

    <script>
      const chatContainer = document.getElementById("chatContainer");
      const messageInput = document.getElementById("messageInput");
      const sendButton = document.getElementById("sendButton");

      // A simple session ID - in a real app, you might use a UUID
      const sessionId = "browser-session-" + Date.now();

      // Function to add a message to the chat display
      function addMessage(content, sender) {
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message", sender);
        messageDiv.textContent = content;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }

      // Function to send a message and handle the streaming response
      async function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Display user message
        addMessage(message, "user");

        // Clear input field
        messageInput.value = "";

        // Create a div for the assistant's response that we'll update as chunks arrive
        const responseDiv = document.createElement("div");
        responseDiv.classList.add("message", "assistant");
        responseDiv.textContent = "";
        chatContainer.appendChild(responseDiv);

        try {
          // Make the API request
          const response = await fetch("http://localhost:3000/api/chat", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ message, sessionId }),
          });

          // Set up event source for streaming
          const reader = response.body.getReader();
          const decoder = new TextDecoder();

          // Process the stream
          while (true) {
            const { value, done } = await reader.read();

            if (done) break;

            // Decode the received chunk
            const chunk = decoder.decode(value, { stream: true });
            console.log({ chunk });

            // Process each line in the chunk
            const lines = chunk.split("\n\n");
            for (const line of lines) {
              if (line.startsWith("data: ")) {
                try {
                  const data = JSON.parse(line.slice(6));

                  if (data.text) {
                    // Append to the current response
                    responseDiv.textContent += data.text;
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                  }

                  if (data.done) {
                    console.log("Stream complete");
                  }

                  if (data.error) {
                    console.error("Error:", data.error);
                    responseDiv.textContent += ` [Error: ${data.error}]`;
                  }
                } catch (err) {
                  console.error("Error parsing SSE data:", err);
                }
              }
            }
          }
        } catch (err) {
          console.error("Network error:", err);
          responseDiv.textContent =
            "Error connecting to the server. Please try again.";
        }
      }

      // Event listeners
      sendButton.addEventListener("click", sendMessage);
      messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
      });
    </script>
  </body>
</html>
